<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - MHL Media Manager</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>
            <i class="fas fa-bug text-warning me-2"></i>
            Debug - MHL Media Manager
        </h1>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-server me-2"></i>√âtat du serveur</h5>
                    </div>
                    <div class="card-body">
                        <div id="server-status" class="mb-3">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Test en cours...
                        </div>
                        <button id="test-server" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>Tester le serveur
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cloud me-2"></i>√âtat de l'API</h5>
                    </div>
                    <div class="card-body">
                        <div id="api-status" class="mb-3">
                            <div class="text-muted">Non test√©</div>
                        </div>
                        <button id="test-api" class="btn btn-info">
                            <i class="fas fa-play me-2"></i>Tester l'API
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Logs de debug</h5>
                    </div>
                    <div class="card-body">
                        <div id="debug-logs" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <div class="text-muted">Les logs appara√Ætront ici...</div>
                        </div>
                        <button id="clear-logs" class="btn btn-secondary mt-2">
                            <i class="fas fa-trash me-2"></i>Vider les logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <a href="/" class="btn btn-success">
                <i class="fas fa-arrow-left me-2"></i>
                Retour √† l'application
            </a>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        class DebugTool {
            constructor() {
                this.logContainer = document.getElementById('debug-logs');
                this.init();
            }
            
            init() {
                this.log('üöÄ Debug tool initialis√©');
                
                // Auto-test au chargement
                setTimeout(() => {
                    this.testServer();
                }, 1000);
                
                // Event listeners
                document.getElementById('test-server').addEventListener('click', () => {
                    this.testServer();
                });
                
                document.getElementById('test-api').addEventListener('click', () => {
                    this.testAPI();
                });
                
                document.getElementById('clear-logs').addEventListener('click', () => {
                    this.clearLogs();
                });
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const colors = {
                    info: '#007bff',
                    success: '#28a745',
                    error: '#dc3545',
                    warning: '#ffc107'
                };
                
                const logEntry = document.createElement('div');
                logEntry.style.color = colors[type] || colors.info;
                logEntry.innerHTML = `[${timestamp}] ${message}`;
                
                this.logContainer.appendChild(logEntry);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
            }
            
            clearLogs() {
                this.logContainer.innerHTML = '<div class="text-muted">Logs vid√©s...</div>';
            }
            
            updateStatus(elementId, status, type = 'info') {
                const element = document.getElementById(elementId);
                const icons = {
                    loading: '<div class="spinner-border spinner-border-sm me-2"></div>',
                    success: '<i class="fas fa-check text-success me-2"></i>',
                    error: '<i class="fas fa-times text-danger me-2"></i>',
                    info: '<i class="fas fa-info text-info me-2"></i>'
                };
                
                element.innerHTML = icons[type] + status;
            }
            
            async testServer() {
                this.log('üîç Test du serveur...', 'info');
                this.updateStatus('server-status', 'Test en cours...', 'loading');
                
                try {
                    const response = await fetch('/health', {
                        method: 'GET',
                        timeout: 5000
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.log('‚úÖ Serveur accessible', 'success');
                        this.log(`üìä Status: ${data.status}`, 'success');
                        this.log(`üïí Timestamp: ${data.timestamp}`, 'info');
                        this.log(`üåç Environment: ${data.environment}`, 'info');
                        this.updateStatus('server-status', 'Serveur OK', 'success');
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    this.log('‚ùå Erreur serveur: ' + error.message, 'error');
                    this.updateStatus('server-status', 'Erreur: ' + error.message, 'error');
                }
            }
            
            async testAPI() {
                this.log('üîç Test de l\'API blobs...', 'info');
                this.updateStatus('api-status', 'Test en cours...', 'loading');
                
                try {
                    const response = await fetch('/api/blobs', {
                        method: 'GET',
                        timeout: 10000
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.log('‚úÖ API accessible', 'success');
                        this.log(`üìÅ Blobs trouv√©s: ${data.count}`, 'success');
                        
                        if (data.data && data.data.length > 0) {
                            data.data.forEach((blob, index) => {
                                this.log(`  ${index + 1}. ${blob.displayName} (${this.formatSize(blob.size)})`, 'info');
                            });
                        } else {
                            this.log('üì≠ Container vide (aucun blob)', 'info');
                        }
                        
                        this.updateStatus('api-status', `API OK (${data.count} fichiers)`, 'success');
                    } else {
                        const errorData = await response.json().catch(() => ({ error: 'R√©ponse non JSON' }));
                        throw new Error(`HTTP ${response.status}: ${errorData.error || 'Erreur inconnue'}`);
                    }
                } catch (error) {
                    this.log('‚ùå Erreur API: ' + error.message, 'error');
                    this.updateStatus('api-status', 'Erreur: ' + error.message, 'error');
                    
                    // Suggestions de r√©solution
                    if (error.message.includes('This request is not authorized')) {
                        this.log('üí° Suggestion: V√©rifier les r√¥les RBAC Azure', 'warning');
                        this.log('   - Storage Blob Data Contributor requis', 'warning');
                    }
                    if (error.message.includes('Failed to fetch')) {
                        this.log('üí° Suggestion: V√©rifier que le serveur est d√©marr√©', 'warning');
                    }
                }
            }
            
            formatSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }
        
        // Initialiser le debug tool
        $(document).ready(() => {
            window.debugTool = new DebugTool();
        });
        
        // Log les erreurs JavaScript
        window.addEventListener('error', (event) => {
            if (window.debugTool) {
                window.debugTool.log('üö® Erreur JS: ' + event.message, 'error');
            }
        });
        
        // Log les erreurs de fetch
        window.addEventListener('unhandledrejection', (event) => {
            if (window.debugTool) {
                window.debugTool.log('üö® Promise rejet√©e: ' + event.reason, 'error');
            }
        });
    </script>
</body>
</html>